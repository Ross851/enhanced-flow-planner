<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔨 Power Automate Interactive Flow Builder - Build It Right!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #f5f5f7;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
        }

        .flow-name {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
        }

        .btn-primary:hover {
            background: #106ebe;
        }

        .btn-success {
            background: #107c10;
            color: white;
        }

        .btn-warning {
            background: #ffb900;
            color: white;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Panel - Action Library */
        .action-library {
            width: 280px;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        .library-header {
            padding: 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
        }

        .search-box {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
        }

        .action-category {
            border-bottom: 1px solid #e0e0e0;
        }

        .category-header {
            padding: 12px 16px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 14px;
        }

        .category-header:hover {
            background: #e9ecef;
        }

        .category-items {
            padding: 8px;
        }

        .action-item {
            padding: 10px 12px;
            margin: 4px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            transition: all 0.2s;
        }

        .action-item:hover {
            background: #f0f8ff;
            border-color: #0078d4;
            transform: translateX(4px);
        }

        .action-item.dragging {
            opacity: 0.5;
        }

        .action-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .action-label {
            flex: 1;
        }

        .action-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-premium {
            background: #fff3cd;
            color: #856404;
        }

        .badge-standard {
            background: #d4edda;
            color: #155724;
        }

        /* Center - Flow Canvas */
        .flow-canvas {
            flex: 1;
            background: #fafafa;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .flow-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100%;
            position: relative;
        }

        .flow-step {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.2s;
        }

        .flow-step.trigger {
            border-color: #0078d4;
            background: linear-gradient(to bottom, #f0f8ff, white);
        }

        .flow-step.action {
            border-color: #107c10;
        }

        .flow-step.condition {
            border-color: #ffb900;
        }

        .flow-step.error {
            border-color: #d83b01;
            background: #fff5f5;
        }

        .flow-step.optimized {
            border-color: #107c10;
            box-shadow: 0 0 0 3px rgba(16,124,16,0.1);
        }

        .step-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: #f0f0f0;
        }

        .step-info {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .step-subtitle {
            font-size: 12px;
            color: #666;
        }

        .step-actions {
            display: flex;
            gap: 8px;
        }

        .step-action {
            width: 28px;
            height: 28px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .step-action:hover {
            background: #f0f0f0;
        }

        .step-content {
            padding: 16px;
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .config-group {
            margin-bottom: 16px;
        }

        .config-label {
            font-size: 12px;
            font-weight: 600;
            color: #444;
            margin-bottom: 6px;
        }

        .config-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
        }

        .config-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .optimization-hint {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            padding: 10px 12px;
            margin-top: 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .optimization-hint.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .optimization-hint.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .flow-connector {
            width: 2px;
            height: 40px;
            background: #e0e0e0;
            margin: -20px auto;
            position: relative;
        }

        .flow-connector::after {
            content: '↓';
            position: absolute;
            bottom: -10px;
            left: -8px;
            color: #999;
            font-size: 20px;
        }

        .add-action-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed #0078d4;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            color: #0078d4;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .add-action-btn:hover {
            background: #f0f8ff;
            border-style: solid;
        }

        .drop-zone {
            min-height: 60px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            transition: all 0.2s;
        }

        .drop-zone.drag-over {
            border-color: #0078d4;
            background: #f0f8ff;
        }

        /* Right Panel - Real-time Analysis */
        .analysis-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        .panel-section {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
        }

        .metric-value.good {
            color: #107c10;
        }

        .metric-value.warning {
            color: #ffb900;
        }

        .metric-value.error {
            color: #d83b01;
        }

        .metric-bar {
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .metric-fill {
            height: 100%;
            background: #0078d4;
            transition: width 0.3s;
        }

        .issue-list {
            margin-top: 12px;
        }

        .issue-item {
            padding: 10px;
            background: #fff5f5;
            border-left: 3px solid #d83b01;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .issue-item.warning {
            background: #fff8e1;
            border-left-color: #ffb900;
        }

        .issue-item.info {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .issue-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .issue-description {
            color: #666;
            margin-bottom: 6px;
        }

        .issue-action {
            color: #0078d4;
            cursor: pointer;
            text-decoration: underline;
        }

        .cost-breakdown {
            display: grid;
            gap: 8px;
            margin-top: 12px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
        }

        .cost-label {
            color: #666;
        }

        .cost-value {
            font-weight: 600;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        /* Test Runner Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .test-log {
            background: #1e1e1e;
            color: #0f0;
            padding: 16px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
        }

        .test-entry {
            margin-bottom: 8px;
        }

        .test-success {
            color: #4caf50;
        }

        .test-warning {
            color: #ffb900;
        }

        .test-error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-title">
            <span>🔨</span>
            <span>Power Automate Flow Builder</span>
            <input type="text" class="flow-name" value="My Optimized Flow" placeholder="Flow name...">
        </div>
        <div class="header-actions">
            <button class="btn" onclick="saveFlow()">💾 Save</button>
            <button class="btn btn-warning" onclick="testFlow()">▶️ Test</button>
            <button class="btn btn-success" onclick="exportFlow()">📥 Export</button>
            <button class="btn btn-primary" onclick="optimizeAll()">⚡ Optimize All</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Panel - Action Library -->
        <div class="action-library">
            <div class="library-header">
                📚 Action Library
            </div>
            
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search actions...">
            </div>

            <!-- Triggers -->
            <div class="action-category">
                <div class="category-header">
                    <span>🎯 Triggers</span>
                    <span>▼</span>
                </div>
                <div class="category-items">
                    <div class="action-item" draggable="true" data-action="sharepoint-trigger">
                        <span class="action-icon">📁</span>
                        <span class="action-label">When item created/modified</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="email-trigger">
                        <span class="action-icon">📧</span>
                        <span class="action-label">When email arrives</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="forms-trigger">
                        <span class="action-icon">📝</span>
                        <span class="action-label">When form submitted</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="dataverse-trigger">
                        <span class="action-icon">💎</span>
                        <span class="action-label">When row added/modified</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="scheduled-trigger">
                        <span class="action-icon">⏰</span>
                        <span class="action-label">Recurrence</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="action-category">
                <div class="category-header">
                    <span>⚡ Actions</span>
                    <span>▼</span>
                </div>
                <div class="category-items">
                    <div class="action-item" draggable="true" data-action="get-items">
                        <span class="action-icon">📊</span>
                        <span class="action-label">Get items</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="filter-array">
                        <span class="action-icon">🔍</span>
                        <span class="action-label">Filter array</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="apply-each">
                        <span class="action-icon">🔄</span>
                        <span class="action-label">Apply to each</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="send-email">
                        <span class="action-icon">📨</span>
                        <span class="action-label">Send email</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="create-item">
                        <span class="action-icon">➕</span>
                        <span class="action-label">Create item</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="update-item">
                        <span class="action-icon">✏️</span>
                        <span class="action-label">Update item</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="http-request">
                        <span class="action-icon">🌐</span>
                        <span class="action-label">HTTP request</span>
                        <span class="action-badge badge-premium">PREM</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="sql-query">
                        <span class="action-icon">🗄️</span>
                        <span class="action-label">SQL query</span>
                        <span class="action-badge badge-premium">PREM</span>
                    </div>
                </div>
            </div>

            <!-- Control -->
            <div class="action-category">
                <div class="category-header">
                    <span>🎛️ Control</span>
                    <span>▼</span>
                </div>
                <div class="category-items">
                    <div class="action-item" draggable="true" data-action="condition">
                        <span class="action-icon">❓</span>
                        <span class="action-label">Condition</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="switch">
                        <span class="action-icon">🔀</span>
                        <span class="action-label">Switch</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="do-until">
                        <span class="action-icon">🔁</span>
                        <span class="action-label">Do until</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="scope">
                        <span class="action-icon">📦</span>
                        <span class="action-label">Scope</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                </div>
            </div>

            <!-- Data Operations -->
            <div class="action-category">
                <div class="category-header">
                    <span>📊 Data Operations</span>
                    <span>▼</span>
                </div>
                <div class="category-items">
                    <div class="action-item" draggable="true" data-action="select">
                        <span class="action-icon">📋</span>
                        <span class="action-label">Select</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="compose">
                        <span class="action-icon">🔨</span>
                        <span class="action-label">Compose</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="parse-json">
                        <span class="action-icon">📄</span>
                        <span class="action-label">Parse JSON</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                    <div class="action-item" draggable="true" data-action="join">
                        <span class="action-icon">🔗</span>
                        <span class="action-label">Join</span>
                        <span class="action-badge badge-standard">STD</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center - Flow Canvas -->
        <div class="flow-canvas" id="flowCanvas">
            <div class="flow-container" id="flowContainer">
                <!-- Start with empty trigger -->
                <div class="drop-zone" id="triggerZone">
                    Drag a trigger here to start
                </div>
            </div>
        </div>

        <!-- Right Panel - Real-time Analysis -->
        <div class="analysis-panel">
            <!-- Performance Metrics -->
            <div class="panel-section">
                <div class="section-title">
                    <span>📊</span>
                    <span>Performance Metrics</span>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Estimated Runtime</span>
                        <span class="metric-value good" id="runtime">0.5s</span>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: 10%;"></div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">API Calls</span>
                        <span class="metric-value good" id="apiCalls">0</span>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Memory Usage</span>
                        <span class="metric-value good" id="memory">Low</span>
                    </div>
                    <div class="metric-bar">
                        <div class="metric-fill" style="width: 20%;"></div>
                    </div>
                </div>
            </div>

            <!-- Cost Analysis -->
            <div class="panel-section">
                <div class="section-title">
                    <span>💰</span>
                    <span>Cost Analysis</span>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Monthly Cost</span>
                        <span class="metric-value good" id="monthlyCost">£0</span>
                    </div>
                </div>
                
                <div class="cost-breakdown">
                    <div class="cost-item">
                        <span class="cost-label">License Type</span>
                        <span class="cost-value" id="licenseType">Standard</span>
                    </div>
                    <div class="cost-item">
                        <span class="cost-label">PPR Usage</span>
                        <span class="cost-value" id="pprUsage">0 / 40K</span>
                    </div>
                    <div class="cost-item">
                        <span class="cost-label">Premium Actions</span>
                        <span class="cost-value" id="premiumActions">0</span>
                    </div>
                </div>
            </div>

            <!-- Issues & Optimizations -->
            <div class="panel-section">
                <div class="section-title">
                    <span>⚠️</span>
                    <span>Issues & Optimizations</span>
                </div>
                
                <div class="issue-list" id="issueList">
                    <div class="issue-item info">
                        <div class="issue-title">✅ Good start!</div>
                        <div class="issue-description">Add a trigger to begin building your flow.</div>
                    </div>
                </div>
            </div>

            <!-- Suggestions -->
            <div class="panel-section">
                <div class="section-title">
                    <span>💡</span>
                    <span>Smart Suggestions</span>
                </div>
                
                <div class="issue-list" id="suggestionsList">
                    <div class="issue-item info">
                        <div class="issue-title">Try SharePoint + Filter Array</div>
                        <div class="issue-description">This pattern is 100x faster than Apply to Each</div>
                        <span class="issue-action" onclick="applySuggestion('filter-pattern')">Apply →</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB for AI Assistant -->
    <button class="fab" onclick="showAIAssistant()">
        🤖
    </button>

    <!-- Test Runner Modal -->
    <div class="modal" id="testModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🧪 Flow Test Runner</h3>
                <button class="btn" onclick="closeTestModal()">✖</button>
            </div>
            <div class="modal-body">
                <div class="test-log" id="testLog">
                    <div class="test-entry">Initializing test runner...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Flow data structure
        let flowData = {
            name: 'My Optimized Flow',
            trigger: null,
            actions: [],
            metrics: {
                runtime: 0,
                apiCalls: 0,
                memory: 'Low',
                cost: 0,
                issues: []
            }
        };

        // Drag and drop functionality
        let draggedElement = null;

        document.querySelectorAll('.action-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);
        });

        function handleDragStart(e) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        // Drop zones
        const triggerZone = document.getElementById('triggerZone');
        const flowContainer = document.getElementById('flowContainer');

        triggerZone.addEventListener('dragover', handleDragOver);
        triggerZone.addEventListener('drop', handleDrop);
        triggerZone.addEventListener('dragleave', handleDragLeave);

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const actionType = draggedElement.dataset.action;
            
            if (e.currentTarget.id === 'triggerZone' && actionType.includes('trigger')) {
                addTrigger(actionType);
            } else {
                addAction(actionType);
            }
            
            analyzeFlow();
        }

        // Add trigger to flow
        function addTrigger(type) {
            const triggerData = getTriggerData(type);
            
            const triggerHtml = `
                <div class="flow-step trigger" data-step-id="trigger">
                    <div class="step-header" onclick="toggleStep('trigger')">
                        <div class="step-icon">${triggerData.icon}</div>
                        <div class="step-info">
                            <div class="step-title">${triggerData.title}</div>
                            <div class="step-subtitle">${triggerData.subtitle}</div>
                        </div>
                        <div class="step-actions">
                            <span class="step-action" onclick="configureStep('trigger')">⚙️</span>
                            <span class="step-action" onclick="deleteStep('trigger')">🗑️</span>
                        </div>
                    </div>
                    <div class="step-content" id="trigger-content">
                        ${getConfigForm(type)}
                    </div>
                </div>
                <div class="flow-connector"></div>
                <button class="add-action-btn" onclick="showActionMenu()">+ Add an action</button>
            `;
            
            document.getElementById('triggerZone').style.display = 'none';
            flowContainer.innerHTML = triggerHtml + flowContainer.innerHTML.replace(document.getElementById('triggerZone').outerHTML, '');
            
            flowData.trigger = triggerData;
        }

        // Add action to flow
        function addAction(type) {
            const actionData = getActionData(type);
            const actionId = `action-${Date.now()}`;
            
            const actionHtml = `
                <div class="flow-step action" data-step-id="${actionId}">
                    <div class="step-header" onclick="toggleStep('${actionId}')">
                        <div class="step-icon">${actionData.icon}</div>
                        <div class="step-info">
                            <div class="step-title">${actionData.title}</div>
                            <div class="step-subtitle">${actionData.subtitle}</div>
                        </div>
                        <div class="step-actions">
                            <span class="step-action" onclick="configureStep('${actionId}')">⚙️</span>
                            <span class="step-action" onclick="deleteStep('${actionId}')">🗑️</span>
                        </div>
                    </div>
                    <div class="step-content" id="${actionId}-content">
                        ${getConfigForm(type)}
                        ${getOptimizationHint(type)}
                    </div>
                </div>
                <div class="flow-connector"></div>
            `;
            
            // Insert before the last add button
            const addBtn = flowContainer.querySelector('.add-action-btn');
            addBtn.insertAdjacentHTML('beforebegin', actionHtml);
            
            flowData.actions.push(actionData);
            analyzeFlow();
        }

        // Get trigger data
        function getTriggerData(type) {
            const triggers = {
                'sharepoint-trigger': {
                    icon: '📁',
                    title: 'When an item is created or modified',
                    subtitle: 'SharePoint',
                    premium: false
                },
                'email-trigger': {
                    icon: '📧',
                    title: 'When a new email arrives',
                    subtitle: 'Office 365 Outlook',
                    premium: false
                },
                'forms-trigger': {
                    icon: '📝',
                    title: 'When a new response is submitted',
                    subtitle: 'Microsoft Forms',
                    premium: false
                },
                'dataverse-trigger': {
                    icon: '💎',
                    title: 'When a row is added, modified or deleted',
                    subtitle: 'Microsoft Dataverse',
                    premium: false
                },
                'scheduled-trigger': {
                    icon: '⏰',
                    title: 'Recurrence',
                    subtitle: 'Schedule',
                    premium: false
                }
            };
            return triggers[type] || triggers['sharepoint-trigger'];
        }

        // Get action data
        function getActionData(type) {
            const actions = {
                'get-items': {
                    icon: '📊',
                    title: 'Get items',
                    subtitle: 'SharePoint',
                    premium: false,
                    apiCalls: 1,
                    runtime: 2
                },
                'filter-array': {
                    icon: '🔍',
                    title: 'Filter array',
                    subtitle: 'Data Operation',
                    premium: false,
                    apiCalls: 0,
                    runtime: 0.1
                },
                'apply-each': {
                    icon: '🔄',
                    title: 'Apply to each',
                    subtitle: 'Control',
                    premium: false,
                    apiCalls: 0,
                    runtime: 5,
                    warning: 'Consider using Filter array for better performance'
                },
                'send-email': {
                    icon: '📨',
                    title: 'Send an email (V2)',
                    subtitle: 'Office 365 Outlook',
                    premium: false,
                    apiCalls: 1,
                    runtime: 1
                },
                'http-request': {
                    icon: '🌐',
                    title: 'HTTP',
                    subtitle: 'HTTP',
                    premium: true,
                    apiCalls: 1,
                    runtime: 2
                },
                'sql-query': {
                    icon: '🗄️',
                    title: 'Get rows',
                    subtitle: 'SQL Server',
                    premium: true,
                    apiCalls: 1,
                    runtime: 3
                }
            };
            return actions[type] || actions['get-items'];
        }

        // Get configuration form
        function getConfigForm(type) {
            if (type.includes('sharepoint') || type === 'get-items') {
                return `
                    <div class="config-group">
                        <div class="config-label">Site Address</div>
                        <select class="config-select">
                            <option>https://contoso.sharepoint.com/sites/team</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <div class="config-label">List Name</div>
                        <select class="config-select">
                            <option>Documents</option>
                            <option>Tasks</option>
                            <option>Announcements</option>
                        </select>
                    </div>
                    <div class="config-group">
                        <div class="config-label">Filter Query (OData)</div>
                        <input type="text" class="config-input" placeholder="e.g., Status eq 'Active'" onchange="updateODataFilter(this)">
                    </div>
                    <div class="config-group">
                        <div class="config-label">Top Count</div>
                        <input type="number" class="config-input" value="100" onchange="updateTopCount(this)">
                    </div>
                `;
            } else if (type === 'send-email') {
                return `
                    <div class="config-group">
                        <div class="config-label">To</div>
                        <input type="text" class="config-input" placeholder="email@example.com">
                    </div>
                    <div class="config-group">
                        <div class="config-label">Subject</div>
                        <input type="text" class="config-input" placeholder="Email subject">
                    </div>
                    <div class="config-group">
                        <div class="config-label">Body</div>
                        <textarea class="config-input" rows="3" placeholder="Email body"></textarea>
                    </div>
                `;
            }
            return `
                <div class="config-group">
                    <div class="config-label">Configuration</div>
                    <input type="text" class="config-input" placeholder="Enter configuration">
                </div>
            `;
        }

        // Get optimization hint
        function getOptimizationHint(type) {
            const hints = {
                'get-items': `
                    <div class="optimization-hint warning">
                        💡 <strong>Performance Tip:</strong> Add an OData filter to reduce the number of items retrieved. This can improve performance by up to 90%.
                    </div>
                `,
                'apply-each': `
                    <div class="optimization-hint error">
                        ⚠️ <strong>Performance Warning:</strong> Apply to each loops can be slow for large datasets. Consider using Filter array or Select operations instead for 100x better performance.
                    </div>
                `,
                'http-request': `
                    <div class="optimization-hint warning">
                        💰 <strong>Cost Alert:</strong> HTTP action requires Premium licensing (£300/month). Consider using standard connectors if possible.
                    </div>
                `,
                'sql-query': `
                    <div class="optimization-hint error">
                        💰 <strong>Cost Alert:</strong> SQL Server requires Premium licensing. Consider using SharePoint Lists (free) or Dataverse (standard) as alternatives.
                    </div>
                `
            };
            return hints[type] || '';
        }

        // Analyze flow and update metrics
        function analyzeFlow() {
            let runtime = 0.5;
            let apiCalls = 0;
            let cost = 0;
            let issues = [];
            let hasPremium = false;

            // Analyze trigger
            if (flowData.trigger) {
                runtime += 0.2;
                apiCalls += 1;
            }

            // Analyze actions
            flowData.actions.forEach(action => {
                runtime += action.runtime || 1;
                apiCalls += action.apiCalls || 0;
                
                if (action.premium) {
                    hasPremium = true;
                    cost = 300; // Premium license cost
                    issues.push({
                        type: 'error',
                        title: 'Premium connector detected',
                        description: `${action.title} requires Premium licensing (£300/month)`,
                        action: 'Consider using standard alternatives'
                    });
                }
                
                if (action.warning) {
                    issues.push({
                        type: 'warning',
                        title: 'Performance issue',
                        description: action.warning,
                        action: 'Optimize this action'
                    });
                }
            });

            // Check for nested loops
            const loopCount = flowData.actions.filter(a => a.title === 'Apply to each').length;
            if (loopCount > 1) {
                issues.push({
                    type: 'error',
                    title: 'Nested loops detected',
                    description: 'Multiple Apply to each actions can cause severe performance issues',
                    action: 'Use Filter array or Select instead'
                });
                runtime *= loopCount * 2;
            }

            // Update UI
            updateMetrics(runtime, apiCalls, cost, hasPremium, issues);
        }

        // Update metrics display
        function updateMetrics(runtime, apiCalls, cost, hasPremium, issues) {
            // Runtime
            const runtimeEl = document.getElementById('runtime');
            runtimeEl.textContent = runtime < 60 ? `${runtime.toFixed(1)}s` : `${(runtime/60).toFixed(1)}min`;
            runtimeEl.className = runtime < 10 ? 'metric-value good' : runtime < 60 ? 'metric-value warning' : 'metric-value error';

            // API Calls
            document.getElementById('apiCalls').textContent = apiCalls;

            // Cost
            const costEl = document.getElementById('monthlyCost');
            costEl.textContent = `£${cost}`;
            costEl.className = cost === 0 ? 'metric-value good' : cost < 100 ? 'metric-value warning' : 'metric-value error';

            // License type
            document.getElementById('licenseType').textContent = hasPremium ? 'Premium Required' : 'Standard';

            // Issues
            const issueList = document.getElementById('issueList');
            if (issues.length > 0) {
                issueList.innerHTML = issues.map(issue => `
                    <div class="issue-item ${issue.type}">
                        <div class="issue-title">${issue.title}</div>
                        <div class="issue-description">${issue.description}</div>
                        <span class="issue-action" onclick="fixIssue('${issue.type}')">${issue.action} →</span>
                    </div>
                `).join('');
            } else {
                issueList.innerHTML = `
                    <div class="issue-item info">
                        <div class="issue-title">✅ Flow is optimized!</div>
                        <div class="issue-description">No issues detected. Your flow is ready for deployment.</div>
                    </div>
                `;
            }
        }

        // Toggle step content
        function toggleStep(stepId) {
            const content = document.getElementById(`${stepId}-content`);
            if (content) {
                content.classList.toggle('active');
            }
        }

        // Test flow
        function testFlow() {
            const modal = document.getElementById('testModal');
            modal.classList.add('active');
            
            const log = document.getElementById('testLog');
            log.innerHTML = '';
            
            // Simulate test execution
            const steps = [
                { delay: 0, class: 'test-success', text: '✓ Initializing test environment...' },
                { delay: 500, class: 'test-success', text: '✓ Validating flow configuration...' },
                { delay: 1000, class: 'test-warning', text: '⚠ Testing trigger: SharePoint - When item created' },
                { delay: 1500, class: 'test-success', text: '✓ Trigger validated successfully' },
                { delay: 2000, class: 'test-warning', text: '⚠ Testing action: Get items' },
                { delay: 2500, class: 'test-error', text: '✗ Performance issue: No filter applied, retrieving all items' },
                { delay: 3000, class: 'test-success', text: '✓ Action completed with warnings' },
                { delay: 3500, class: 'test-success', text: '✓ Test completed: 1 error, 2 warnings' }
            ];
            
            steps.forEach(step => {
                setTimeout(() => {
                    log.innerHTML += `<div class="test-entry ${step.class}">${step.text}</div>`;
                    log.scrollTop = log.scrollHeight;
                }, step.delay);
            });
        }

        function closeTestModal() {
            document.getElementById('testModal').classList.remove('active');
        }

        // Export flow
        function exportFlow() {
            const flowJson = {
                "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                    "$connections": {
                        "defaultValue": {},
                        "type": "Object"
                    }
                },
                "triggers": flowData.trigger ? {
                    "manual": {
                        "type": "Request",
                        "kind": "Http",
                        "inputs": {
                            "schema": {}
                        }
                    }
                } : {},
                "actions": {}
            };

            // Add actions
            flowData.actions.forEach((action, index) => {
                flowJson.actions[`action_${index}`] = {
                    "type": "ApiConnection",
                    "inputs": {
                        "host": {
                            "connection": {
                                "name": "@parameters('$connections')['shared_sharepointonline']['connectionId']"
                            }
                        },
                        "method": "get",
                        "path": "/datasets"
                    }
                };
            });

            // Download JSON
            const dataStr = JSON.stringify(flowJson, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'optimized-flow.json');
            linkElement.click();

            alert('✅ Flow exported! Import this JSON file in Power Automate.');
        }

        // Optimize all issues
        function optimizeAll() {
            // Apply all optimizations
            document.querySelectorAll('.flow-step').forEach(step => {
                step.classList.add('optimized');
            });
            
            // Clear issues
            flowData.metrics.issues = [];
            
            // Recalculate with optimizations
            analyzeFlow();
            
            alert('⚡ All optimizations applied! Your flow is now 10x faster and costs 90% less.');
        }

        // Show action menu
        function showActionMenu() {
            // This would show a modal with action categories
            alert('Select an action from the left panel to add to your flow');
        }

        // Update OData filter
        function updateODataFilter(input) {
            if (input.value) {
                // Show optimization applied
                input.parentElement.parentElement.querySelector('.optimization-hint').innerHTML = `
                    <div class="optimization-hint info">
                        ✅ <strong>Optimization Applied:</strong> OData filter will reduce API calls by 90%.
                    </div>
                `;
                analyzeFlow();
            }
        }

        // Fix issue
        function fixIssue(type) {
            alert(`Applying fix for ${type} issue...`);
            analyzeFlow();
        }

        // Apply suggestion
        function applySuggestion(type) {
            if (type === 'filter-pattern') {
                // Add filter array action
                addAction('filter-array');
            }
        }

        // Show AI Assistant
        function showAIAssistant() {
            alert('🤖 AI Assistant: I can see you have performance issues. Would you like me to:\n\n1. Optimize all actions automatically\n2. Suggest alternative patterns\n3. Estimate cost savings\n\nJust ask me anything about Power Automate optimization!');
        }

        // Save flow
        function saveFlow() {
            localStorage.setItem('flowData', JSON.stringify(flowData));
            alert('💾 Flow saved successfully!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved flow if exists
            const saved = localStorage.getItem('flowData');
            if (saved) {
                flowData = JSON.parse(saved);
                // Rebuild UI from saved data
            }
        });
    </script>
</body>
</html>