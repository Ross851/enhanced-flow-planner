<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Automate Complete Impact Analyser - Understand BEFORE You Build</title>
    <style>
        :root {
            --ms-blue: #0078d4;
            --ms-blue-dark: #004578;
            --ms-green: #107c10;
            --ms-red: #d13438;
            --ms-orange: #ff8c00;
            --ms-purple: #5c2d91;
            --ms-gray-10: #faf9f8;
            --ms-gray-20: #f3f2f1;
            --ms-gray-30: #edebe9;
            --ms-gray-90: #605e5c;
            --ms-gray-130: #323130;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: var(--ms-blue-dark);
            font-size: 36px;
            margin-bottom: 10px;
        }

        .header-subtitle {
            font-size: 18px;
            color: var(--ms-gray-90);
            margin-bottom: 20px;
        }

        .key-message {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            background: var(--ms-gray-10);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: var(--ms-gray-20);
        }

        .nav-tab.active {
            background: var(--ms-blue);
            color: white;
            border-color: var(--ms-blue-dark);
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Impact Grid */
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .impact-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .impact-card h3 {
            color: var(--ms-gray-130);
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .severity-indicator {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: auto;
        }

        .severity-low { background: var(--ms-green); color: white; }
        .severity-medium { background: var(--ms-orange); color: white; }
        .severity-high { background: var(--ms-red); color: white; }
        .severity-critical { background: var(--ms-red); color: white; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Action Type Comparison */
        .action-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .action-type {
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--ms-gray-30);
        }

        .action-type.bound {
            background: rgba(16, 124, 16, 0.05);
            border-color: var(--ms-green);
        }

        .action-type.unbound {
            background: rgba(255, 140, 0, 0.05);
            border-color: var(--ms-orange);
        }

        .action-type h4 {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .action-type ul {
            list-style: none;
            font-size: 14px;
            color: var(--ms-gray-90);
        }

        .action-type li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .action-type li::before {
            content: "→";
            position: absolute;
            left: 0;
        }

        /* Sync vs Async */
        .sync-async-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .sync-card {
            padding: 20px;
            border-radius: 8px;
            background: white;
            border: 3px solid;
        }

        .sync-card.synchronous {
            border-color: var(--ms-red);
        }

        .sync-card.asynchronous {
            border-color: var(--ms-blue);
        }

        .sync-card h4 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .sync-icon.sync {
            background: rgba(209, 52, 56, 0.1);
            color: var(--ms-red);
        }

        .sync-icon.async {
            background: rgba(0, 120, 212, 0.1);
            color: var(--ms-blue);
        }

        /* Loop Impact Visualizer */
        .loop-visualizer {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .loop-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
        }

        .loop-box {
            padding: 20px;
            border: 3px solid;
            border-radius: 8px;
            text-align: center;
            position: relative;
        }

        .loop-box.level-1 {
            border-color: var(--ms-orange);
            padding: 40px;
        }

        .loop-box.level-2 {
            border-color: var(--ms-red);
            padding: 30px;
        }

        .loop-box.level-3 {
            border-color: var(--ms-red);
            background: rgba(209, 52, 56, 0.1);
            padding: 20px;
        }

        .arrow {
            font-size: 30px;
            color: var(--ms-red);
        }

        /* Real World Scenarios */
        .scenario-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid;
        }

        .scenario-good { border-color: var(--ms-green); }
        .scenario-bad { border-color: var(--ms-red); }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .scenario-title {
            font-size: 18px;
            font-weight: 600;
        }

        .scenario-type {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-good { background: var(--ms-green); color: white; }
        .type-bad { background: var(--ms-red); color: white; }

        .scenario-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--ms-gray-30);
        }

        .metric-item {
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--ms-blue-dark);
        }

        .metric-label {
            font-size: 12px;
            color: var(--ms-gray-90);
            text-transform: uppercase;
        }

        /* Interactive Calculator */
        .calculator-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .calc-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .calc-input {
            display: flex;
            flex-direction: column;
        }

        .calc-input label {
            font-size: 14px;
            color: var(--ms-gray-90);
            margin-bottom: 5px;
        }

        .calc-input input, .calc-input select {
            padding: 10px;
            border: 2px solid var(--ms-gray-30);
            border-radius: 6px;
            font-size: 16px;
        }

        .calc-input input:focus, .calc-input select:focus {
            outline: none;
            border-color: var(--ms-blue);
        }

        .calc-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background: var(--ms-gray-10);
            border-radius: 8px;
        }

        .result-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .result-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .result-label {
            font-size: 14px;
            color: var(--ms-gray-90);
        }

        /* Best Practices */
        .best-practice {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .best-practice h4 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .best-practice p {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--ms-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--ms-blue-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            color: var(--ms-gray-130);
            border: 2px solid var(--ms-gray-30);
        }

        .btn-danger {
            background: var(--ms-red);
            color: white;
        }

        /* Warning Box */
        .warning-box {
            background: rgba(209, 52, 56, 0.1);
            border: 2px solid var(--ms-red);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box h4 {
            color: var(--ms-red);
            margin-bottom: 10px;
        }

        .warning-box ul {
            margin-left: 20px;
            color: var(--ms-gray-130);
        }

        /* Success Box */
        .success-box {
            background: rgba(16, 124, 16, 0.1);
            border: 2px solid var(--ms-green);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .success-box h4 {
            color: var(--ms-green);
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Power Automate Complete Impact Analyser</h1>
            <p class="header-subtitle">Understand the REAL impact of your design decisions BEFORE you build</p>
            <div class="key-message">
                Every design decision has a cost. See it. Understand it. Optimise it.
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('loops')">
                🔄 Loop Impact
            </div>
            <div class="nav-tab" onclick="switchTab('actions')">
                ⚡ Action Types
            </div>
            <div class="nav-tab" onclick="switchTab('sync')">
                🔀 Sync vs Async
            </div>
            <div class="nav-tab" onclick="switchTab('scenarios')">
                📊 Real Scenarios
            </div>
            <div class="nav-tab" onclick="switchTab('calculator')">
                🧮 Calculator
            </div>
        </div>

        <!-- Loop Impact Section -->
        <div class="content-section active" id="loops">
            <div class="loop-visualizer">
                <h2 style="margin-bottom: 20px;">The Apply to Each Multiplication Disaster</h2>
                
                <div class="loop-diagram">
                    <div class="loop-box level-1">
                        <strong>Outer Loop</strong><br>
                        100 items<br>
                        3 actions<br>
                        = 300 calls
                    </div>
                    <span class="arrow">→</span>
                    <div class="loop-box level-2">
                        <strong>Nested Loop</strong><br>
                        100 × 50 items<br>
                        2 actions each<br>
                        = 10,000 calls
                    </div>
                    <span class="arrow">→</span>
                    <div class="loop-box level-3">
                        <strong>Double Nested</strong><br>
                        100 × 50 × 10<br>
                        1 action each<br>
                        = 50,000 calls!
                    </div>
                </div>

                <div class="warning-box">
                    <h4>⚠️ CRITICAL: Why This Happens</h4>
                    <ul>
                        <li>Each Apply to Each iteration is a SEPARATE execution context</li>
                        <li>Every action inside loops multiplies by ALL parent iterations</li>
                        <li>Connection context resets each iteration (more overhead)</li>
                        <li>Memory consumption grows exponentially</li>
                        <li>5-minute timeout becomes a real risk</li>
                    </ul>
                </div>

                <div class="success-box">
                    <h4>✅ How to Fix This</h4>
                    <ul>
                        <li><strong>Filter at source:</strong> Use OData $filter in Get Items (90% reduction)</li>
                        <li><strong>Use Select/Expand:</strong> Get related data in one call, not nested loops</li>
                        <li><strong>Batch operations:</strong> Process multiple items in single API call</li>
                        <li><strong>Filter Array:</strong> In-memory filtering instead of nested loops</li>
                        <li><strong>Parallel branches:</strong> Process independent items simultaneously</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Action Types Section -->
        <div class="content-section" id="actions">
            <div class="impact-card">
                <h3>
                    Bound vs Unbound Actions
                    <span class="severity-indicator severity-high">CRITICAL TO UNDERSTAND</span>
                </h3>
                
                <div class="action-comparison">
                    <div class="action-type bound">
                        <h4>✅ Bound Actions (Efficient)</h4>
                        <ul>
                            <li>Operate on specific record</li>
                            <li>Single API call per operation</li>
                            <li>Examples: Update item, Delete item</li>
                            <li>Use record ID directly</li>
                            <li>Lower throttling risk</li>
                        </ul>
                    </div>
                    <div class="action-type unbound">
                        <h4>⚠️ Unbound Actions (Careful!)</h4>
                        <ul>
                            <li>Operate on entire dataset</li>
                            <li>Can trigger multiple API calls</li>
                            <li>Examples: List items, Filter query</li>
                            <li>Returns multiple records</li>
                            <li>Higher throttling risk</li>
                        </ul>
                    </div>
                </div>

                <div class="best-practice">
                    <h4>Best Practice: Choose Wisely</h4>
                    <p>
                        When you know the specific record ID, ALWAYS use bound actions (Get item by ID) 
                        instead of unbound (Get items with filter). This reduces API calls from potentially 
                        hundreds to just one!
                    </p>
                </div>
            </div>
        </div>

        <!-- Sync vs Async Section -->
        <div class="content-section" id="sync">
            <div class="impact-grid">
                <div class="sync-card synchronous">
                    <h4>
                        <span class="sync-icon sync">⏸️</span>
                        Synchronous Actions (Blocking)
                    </h4>
                    <div style="margin: 20px 0;">
                        <p><strong>How it works:</strong> Flow WAITS for completion</p>
                        <p><strong>Examples:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>HTTP requests (by default)</li>
                            <li>Approval actions</li>
                            <li>Most connector actions</li>
                        </ul>
                        <p><strong>Impact:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px; color: var(--ms-red);">
                            <li>Creates bottlenecks</li>
                            <li>Sequential processing only</li>
                            <li>Longer total execution time</li>
                            <li>Higher timeout risk</li>
                        </ul>
                    </div>
                </div>

                <div class="sync-card asynchronous">
                    <h4>
                        <span class="sync-icon async">▶️</span>
                        Asynchronous Actions (Non-blocking)
                    </h4>
                    <div style="margin: 20px 0;">
                        <p><strong>How it works:</strong> Flow continues while processing</p>
                        <p><strong>Examples:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Send email (fire and forget)</li>
                            <li>Queue messages</li>
                            <li>Webhook responses</li>
                        </ul>
                        <p><strong>Benefits:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px; color: var(--ms-green);">
                            <li>Parallel processing possible</li>
                            <li>Faster overall execution</li>
                            <li>Better resource utilisation</li>
                            <li>Lower timeout risk</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="warning-box">
                <h4>⚠️ Synchronous Bottleneck Example</h4>
                <p>10 HTTP requests × 3 seconds each = 30 seconds (sequential)</p>
                <p>VS</p>
                <p>10 HTTP requests in parallel = 3 seconds (if async/parallel branches)</p>
            </div>
        </div>

        <!-- Real Scenarios Section -->
        <div class="content-section" id="scenarios">
            <h2 style="color: white; margin-bottom: 20px;">Real-World Scenarios: Good vs Bad</h2>
            
            <!-- Bad Scenario -->
            <div class="scenario-card scenario-bad">
                <div class="scenario-header">
                    <span class="scenario-title">❌ The Nightmare: Invoice Processing (BAD)</span>
                    <span class="scenario-type type-bad">WILL FAIL</span>
                </div>
                <p>Get all invoices → Loop through each → Get customer details → Nested loop for line items → Update SQL</p>
                <div class="scenario-metrics">
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-red);">15,000</div>
                        <div class="metric-label">API Calls</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-red);">25 min</div>
                        <div class="metric-label">Execution Time</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-red);">£163.80</div>
                        <div class="metric-label">Monthly Cost</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-red);">100%</div>
                        <div class="metric-label">Failure Rate</div>
                    </div>
                </div>
            </div>

            <!-- Good Scenario -->
            <div class="scenario-card scenario-good">
                <div class="scenario-header">
                    <span class="scenario-title">✅ The Solution: Invoice Processing (OPTIMISED)</span>
                    <span class="scenario-type type-good">EFFICIENT</span>
                </div>
                <p>Get filtered invoices (OData) → Batch update with joins → Single SQL stored procedure → Async email</p>
                <div class="scenario-metrics">
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-green);">150</div>
                        <div class="metric-label">API Calls</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-green);">45 sec</div>
                        <div class="metric-label">Execution Time</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-green);">£0</div>
                        <div class="metric-label">Monthly Cost</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-green);">0%</div>
                        <div class="metric-label">Failure Rate</div>
                    </div>
                </div>
            </div>

            <!-- Another Bad Example -->
            <div class="scenario-card scenario-bad">
                <div class="scenario-header">
                    <span class="scenario-title">❌ The Disaster: SharePoint to Teams Sync</span>
                    <span class="scenario-type type-bad">THROTTLED</span>
                </div>
                <p>Get all files → Loop each → Get metadata → Loop permissions → Post to Teams</p>
                <div class="scenario-metrics">
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-red);">8,000</div>
                        <div class="metric-label">API Calls/min</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-red);">THROTTLED</div>
                        <div class="metric-label">Status</div>
                    </div>
                </div>
            </div>

            <!-- Good Alternative -->
            <div class="scenario-card scenario-good">
                <div class="scenario-header">
                    <span class="scenario-title">✅ The Fix: SharePoint to Teams Sync</span>
                    <span class="scenario-type type-good">SMOOTH</span>
                </div>
                <p>Get changed files only (delta) → Batch get with $expand → Graph API batch → Queue for Teams</p>
                <div class="scenario-metrics">
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-green);">50</div>
                        <div class="metric-label">API Calls/min</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" style="color: var(--ms-green);">RUNNING</div>
                        <div class="metric-label">Status</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculator Section -->
        <div class="content-section" id="calculator">
            <div class="calculator-section">
                <h2 style="margin-bottom: 20px;">Quick Impact Calculator</h2>
                
                <div class="calc-inputs">
                    <div class="calc-input">
                        <label>Flow Runs Per Day</label>
                        <input type="number" id="runsPerDay" value="100" onchange="calculate()">
                    </div>
                    <div class="calc-input">
                        <label>Actions Per Run</label>
                        <input type="number" id="actionsPerRun" value="10" onchange="calculate()">
                    </div>
                    <div class="calc-input">
                        <label>Apply to Each Items</label>
                        <input type="number" id="loopItems" value="0" onchange="calculate()">
                    </div>
                    <div class="calc-input">
                        <label>Actions in Loop</label>
                        <input type="number" id="loopActions" value="0" onchange="calculate()">
                    </div>
                    <div class="calc-input">
                        <label>Nested Loop Items</label>
                        <input type="number" id="nestedItems" value="0" onchange="calculate()">
                    </div>
                    <div class="calc-input">
                        <label>Primary Connector</label>
                        <select id="connector" onchange="calculate()">
                            <option value="sharepoint">SharePoint (600/min)</option>
                            <option value="sql">SQL Premium (300/min)</option>
                            <option value="dataverse">Dataverse (6000/min)</option>
                            <option value="teams">Teams (1800/min)</option>
                        </select>
                    </div>
                    <div class="calc-input">
                        <label>User Count</label>
                        <input type="number" id="userCount" value="10" onchange="calculate()">
                    </div>
                    <div class="calc-input">
                        <label>Action Type</label>
                        <select id="actionType" onchange="calculate()">
                            <option value="bound">Bound (Efficient)</option>
                            <option value="unbound">Unbound (Multiplies)</option>
                        </select>
                    </div>
                </div>

                <div class="calc-results">
                    <div class="result-item">
                        <div class="result-value" id="totalAPICalls" style="color: var(--ms-blue);">0</div>
                        <div class="result-label">Total API Calls/Day</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="monthlyPPR" style="color: var(--ms-purple);">0</div>
                        <div class="result-label">Monthly PPR</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="throttleRisk" style="color: var(--ms-orange);">LOW</div>
                        <div class="result-label">Throttle Risk</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="monthlyCost" style="color: var(--ms-green);">£0</div>
                        <div class="result-label">Monthly Cost</div>
                    </div>
                </div>

                <div id="recommendations" style="margin-top: 20px;">
                    <!-- Recommendations will appear here -->
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="exportAnalysis()">
                Export Analysis
            </button>
            <button class="btn btn-secondary" onclick="loadWorstCase()">
                Show Worst Case
            </button>
            <button class="btn btn-danger" onclick="showDisaster()">
                Show Disaster Scenario
            </button>
        </div>
    </div>

    <script>
        // Tab switching
        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // Calculator
        function calculate() {
            const runsPerDay = parseInt(document.getElementById('runsPerDay').value) || 0;
            const actionsPerRun = parseInt(document.getElementById('actionsPerRun').value) || 0;
            const loopItems = parseInt(document.getElementById('loopItems').value) || 0;
            const loopActions = parseInt(document.getElementById('loopActions').value) || 0;
            const nestedItems = parseInt(document.getElementById('nestedItems').value) || 0;
            const connector = document.getElementById('connector').value;
            const userCount = parseInt(document.getElementById('userCount').value) || 1;
            const actionType = document.getElementById('actionType').value;

            // Calculate base API calls
            let baseAPICalls = runsPerDay * actionsPerRun;
            
            // Add loop multiplication
            if (loopItems > 0) {
                baseAPICalls += runsPerDay * loopItems * loopActions;
            }
            
            // Add nested loop explosion
            if (nestedItems > 0 && loopItems > 0) {
                baseAPICalls += runsPerDay * loopItems * nestedItems * loopActions;
            }
            
            // Unbound actions multiply by average result set
            if (actionType === 'unbound') {
                baseAPICalls *= 10; // Assuming average 10 records returned
            }
            
            // Update displays
            document.getElementById('totalAPICalls').textContent = baseAPICalls.toLocaleString();
            document.getElementById('monthlyPPR').textContent = (baseAPICalls * 30).toLocaleString();
            
            // Calculate throttle risk
            const limits = {
                sharepoint: 600,
                sql: 300,
                dataverse: 6000,
                teams: 1800
            };
            
            const callsPerMinute = Math.ceil(baseAPICalls / (8 * 60)); // Assuming 8-hour workday
            const limit = limits[connector];
            const throttlePercent = (callsPerMinute / limit) * 100;
            
            let throttleRisk = 'LOW';
            let riskColor = 'var(--ms-green)';
            if (throttlePercent > 100) {
                throttleRisk = 'CRITICAL';
                riskColor = 'var(--ms-red)';
            } else if (throttlePercent > 80) {
                throttleRisk = 'HIGH';
                riskColor = 'var(--ms-orange)';
            } else if (throttlePercent > 50) {
                throttleRisk = 'MEDIUM';
                riskColor = 'var(--ms-blue)';
            }
            
            document.getElementById('throttleRisk').textContent = throttleRisk;
            document.getElementById('throttleRisk').style.color = riskColor;
            
            // Calculate cost
            let monthlyCost = 0;
            const monthlyPPR = baseAPICalls * 30;
            
            if (connector === 'sql') {
                // Premium connector
                if (userCount > 6) {
                    monthlyCost = 81.90; // Per-flow
                } else {
                    monthlyCost = 12.20 * userCount; // Per-user
                }
            } else if (monthlyPPR > 40000 * userCount) {
                // Exceeds included PPR
                monthlyCost = 81.90; // Need process license
            }
            
            document.getElementById('monthlyCost').textContent = `£${monthlyCost.toFixed(2)}`;
            
            // Generate recommendations
            generateRecommendations(throttlePercent, loopItems, nestedItems, actionType);
        }

        function generateRecommendations(throttlePercent, loopItems, nestedItems, actionType) {
            const recDiv = document.getElementById('recommendations');
            let html = '';
            
            if (nestedItems > 0) {
                html += `
                    <div class="warning-box">
                        <h4>🚨 CRITICAL: Nested Loops Detected!</h4>
                        <p>Your nested loops are creating exponential API calls. This WILL cause failures.</p>
                        <p><strong>Immediate action required:</strong> Use Filter Array or batch operations instead.</p>
                    </div>
                `;
            }
            
            if (throttlePercent > 80) {
                html += `
                    <div class="warning-box">
                        <h4>⚠️ Throttling Risk: ${throttlePercent.toFixed(0)}% of limit</h4>
                        <p>Implement these immediately:</p>
                        <ul>
                            <li>Add delays between operations</li>
                            <li>Use batch APIs where available</li>
                            <li>Implement exponential backoff retry logic</li>
                        </ul>
                    </div>
                `;
            }
            
            if (actionType === 'unbound' && loopItems > 0) {
                html += `
                    <div class="warning-box">
                        <h4>⚠️ Unbound Actions in Loops</h4>
                        <p>Using unbound actions (like Get Items) inside loops multiplies API calls dramatically.</p>
                        <p><strong>Fix:</strong> Use bound actions with specific IDs, or get all data once before the loop.</p>
                    </div>
                `;
            }
            
            if (html === '') {
                html = `
                    <div class="success-box">
                        <h4>✅ Looking Good!</h4>
                        <p>Your flow design appears efficient. Keep monitoring as requirements change.</p>
                    </div>
                `;
            }
            
            recDiv.innerHTML = html;
        }

        function loadWorstCase() {
            document.getElementById('runsPerDay').value = 500;
            document.getElementById('actionsPerRun').value = 20;
            document.getElementById('loopItems').value = 100;
            document.getElementById('loopActions').value = 5;
            document.getElementById('nestedItems').value = 50;
            document.getElementById('connector').value = 'sharepoint';
            document.getElementById('userCount').value = 20;
            document.getElementById('actionType').value = 'unbound';
            calculate();
        }

        function showDisaster() {
            document.getElementById('runsPerDay').value = 1000;
            document.getElementById('actionsPerRun').value = 10;
            document.getElementById('loopItems').value = 200;
            document.getElementById('loopActions').value = 10;
            document.getElementById('nestedItems').value = 100;
            document.getElementById('connector').value = 'sql';
            document.getElementById('userCount').value = 50;
            document.getElementById('actionType').value = 'unbound';
            calculate();
            
            alert('This configuration would cost £4,095/month and fail constantly due to throttling!');
        }

        function exportAnalysis() {
            const analysis = {
                timestamp: new Date().toISOString(),
                configuration: {
                    runsPerDay: document.getElementById('runsPerDay').value,
                    actionsPerRun: document.getElementById('actionsPerRun').value,
                    loopItems: document.getElementById('loopItems').value,
                    nestedItems: document.getElementById('nestedItems').value,
                    connector: document.getElementById('connector').value,
                    userCount: document.getElementById('userCount').value
                },
                results: {
                    totalAPICalls: document.getElementById('totalAPICalls').textContent,
                    monthlyPPR: document.getElementById('monthlyPPR').textContent,
                    throttleRisk: document.getElementById('throttleRisk').textContent,
                    monthlyCost: document.getElementById('monthlyCost').textContent
                }
            };
            
            const blob = new Blob([JSON.stringify(analysis, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `power-automate-analysis-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Initialize
        calculate();
    </script>
</body>
</html>