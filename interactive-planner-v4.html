<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚙️ Power Automate Interactive Pre-Build Optimizer v4.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --success: #00b300;
            --warning: #ff9900;
            --danger: #cc0000;
            --info: #0099cc;
            --light: #f8f9fa;
            --dark: #212529;
            --border: #dee2e6;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .efficiency-score-header {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .score-meter {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .score-circle {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
        }

        .score-label {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .live-issues-banner {
            background: var(--danger);
            color: white;
            padding: 15px;
            display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .live-issues-banner.warning {
            background: var(--warning);
        }

        .live-issues-banner.info {
            background: var(--info);
        }

        .issue-count {
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 10px;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: 600px;
        }

        .main-content {
            padding: 30px;
        }

        .live-feedback-panel {
            background: #f8f9fa;
            border-left: 2px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            max-height: 800px;
        }

        .feedback-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .feedback-header h3 {
            font-size: 1.3rem;
            color: var(--dark);
        }

        .issue-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--warning);
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .issue-card.critical {
            border-left-color: var(--danger);
        }

        .issue-card.warning {
            border-left-color: var(--warning);
        }

        .issue-card.info {
            border-left-color: var(--info);
        }

        .issue-card.success {
            border-left-color: var(--success);
        }

        .issue-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .issue-icon {
            font-size: 1.5rem;
        }

        .issue-title {
            font-weight: bold;
            color: var(--dark);
        }

        .issue-description {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .issue-impact {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .impact-item {
            display: flex;
            flex-direction: column;
        }

        .impact-label {
            font-size: 0.8rem;
            color: #666;
        }

        .impact-value {
            font-weight: bold;
            color: var(--danger);
        }

        .impact-value.positive {
            color: var(--success);
        }

        .issue-solution {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .solution-header {
            font-weight: bold;
            color: var(--success);
            margin-bottom: 5px;
        }

        .solution-text {
            color: #2e7d32;
            line-height: 1.4;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
        }

        .form-group input.error {
            border-color: var(--danger);
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .input-feedback {
            font-size: 0.85rem;
            margin-top: 5px;
            color: var(--danger);
            display: none;
        }

        .input-feedback.show {
            display: block;
        }

        .optimization-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .preview-header {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .comparison-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .comparison-title {
            font-weight: bold;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .metric-label {
            opacity: 0.8;
        }

        .metric-value {
            font-weight: bold;
        }

        .savings-highlight {
            background: var(--success);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }

        .savings-amount {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: var(--dark);
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 2s infinite;
            margin-right: 5px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .efficiency-breakdown {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .efficiency-metric {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .efficiency-metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .efficiency-metric-label {
            font-size: 0.85rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>⚙️ Power Automate Interactive Pre-Build Optimizer</h1>
            <div class="subtitle">See issues BEFORE you build • Real-time optimization • Maximum efficiency</div>
            
            <div class="efficiency-score-header">
                <div class="score-container">
                    <div class="score-meter">
                        <svg class="score-circle" viewBox="0 0 36 36">
                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="rgba(255,255,255,0.2)"
                                stroke-width="3"/>
                            <path id="efficiency-circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                fill="none"
                                stroke="#4CAF50"
                                stroke-width="3"
                                stroke-dasharray="0, 100"/>
                        </svg>
                        <div class="score-text" id="efficiency-score">0%</div>
                    </div>
                    <div class="score-label">Efficiency Score</div>
                </div>
                
                <div class="efficiency-breakdown">
                    <div class="efficiency-metric">
                        <div class="efficiency-metric-value" id="cost-score">£0</div>
                        <div class="efficiency-metric-label">Monthly Cost</div>
                    </div>
                    <div class="efficiency-metric">
                        <div class="efficiency-metric-value" id="performance-score">0ms</div>
                        <div class="efficiency-metric-label">Runtime</div>
                    </div>
                    <div class="efficiency-metric">
                        <div class="efficiency-metric-value" id="reliability-score">0%</div>
                        <div class="efficiency-metric-label">Reliability</div>
                    </div>
                    <div class="efficiency-metric">
                        <div class="efficiency-metric-value" id="optimization-score">0</div>
                        <div class="efficiency-metric-label">Issues Found</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="live-issues-banner" id="issues-banner">
            <span class="issue-count" id="issue-count">0</span>
            <span id="issue-summary">No issues detected - your flow is optimized!</span>
        </div>

        <div class="content-wrapper">
            <div class="main-content">
                <form id="flow-form">
                    <div class="form-section">
                        <h3>📊 Flow Configuration</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>
                                    Items to Process
                                    <span class="tooltip">ℹ️
                                        <span class="tooltiptext">Total number of items your flow will process in each run</span>
                                    </span>
                                </label>
                                <input type="number" id="items" value="1000" min="1" max="1000000" required>
                                <div class="input-feedback" id="items-feedback"></div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    Actions per Item
                                    <span class="tooltip">ℹ️
                                        <span class="tooltiptext">Average number of actions needed to process each item</span>
                                    </span>
                                </label>
                                <input type="number" id="actionsPerItem" value="3" min="1" max="100" required>
                                <div class="input-feedback" id="actions-feedback"></div>
                            </div>

                            <div class="form-group">
                                <label>
                                    Primary Connector
                                    <span class="tooltip">ℹ️
                                        <span class="tooltiptext">The main service your flow connects to</span>
                                    </span>
                                </label>
                                <select id="connector" required>
                                    <option value="SharePoint">SharePoint (600 RPM)</option>
                                    <option value="Teams">Teams (120 RPM)</option>
                                    <option value="GraphAPI">Graph API (150 RPM)</option>
                                    <option value="SQL">SQL Server (300 RPM) - Premium</option>
                                    <option value="CustomHTTP">Custom HTTP (60 RPM) - Premium</option>
                                    <option value="Dataverse">Dataverse (6000 RPM)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>
                                    Concurrency Level
                                    <span class="tooltip">ℹ️
                                        <span class="tooltiptext">Number of items processed in parallel (1-50)</span>
                                    </span>
                                </label>
                                <input type="number" id="concurrency" value="1" min="1" max="50" required>
                                <div class="input-feedback" id="concurrency-feedback"></div>
                            </div>

                            <div class="form-group">
                                <label>
                                    Daily Executions
                                    <span class="tooltip">ℹ️
                                        <span class="tooltiptext">How many times per day will this flow run?</span>
                                    </span>
                                </label>
                                <input type="number" id="executions" value="1" min="1" max="1440" required>
                                <div class="input-feedback" id="executions-feedback"></div>
                            </div>

                            <div class="form-group">
                                <label>
                                    Flow Pattern
                                    <span class="tooltip">ℹ️
                                        <span class="tooltiptext">The architectural pattern of your flow</span>
                                    </span>
                                </label>
                                <select id="flowPattern" required>
                                    <option value="simple">Simple Sequential</option>
                                    <option value="apply_to_each">Apply to Each Loop</option>
                                    <option value="nested_apply">Nested Apply to Each</option>
                                    <option value="parallel_branches">Parallel Branches</option>
                                    <option value="child_flows">Child Flows</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>
                                    Expected Error Rate (%)
                                    <span class="tooltip">ℹ️
                                        <span class="tooltiptext">Percentage of items that might fail</span>
                                    </span>
                                </label>
                                <input type="number" id="errorRate" value="5" min="0" max="100" required>
                                <div class="input-feedback" id="error-feedback"></div>
                            </div>

                            <div class="form-group">
                                <label>
                                    Average Action Time (ms)
                                    <span class="tooltip">ℹ️
                                        <span class="tooltiptext">How long each action takes to execute</span>
                                    </span>
                                </label>
                                <input type="number" id="avgMs" value="500" min="10" max="10000" required>
                                <div class="input-feedback" id="time-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>🎯 Current Setup</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Number of Users</label>
                                <input type="number" id="users" value="10" min="1" max="10000">
                            </div>
                            <div class="form-group">
                                <label>Existing Premium Licenses</label>
                                <input type="number" id="premiumLicenses" value="0" min="0" max="10000">
                            </div>
                            <div class="form-group">
                                <label>Existing Process Licenses</label>
                                <input type="number" id="processLicenses" value="0" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Governance Level</label>
                                <select id="governanceLevel">
                                    <option value="none">None (High Risk)</option>
                                    <option value="basic">Basic</option>
                                    <option value="standard">Standard</option>
                                    <option value="strict">Strict</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="optimization-preview" id="optimization-preview">
                    <div class="preview-header">📈 Optimization Impact Preview</div>
                    <div class="comparison-grid">
                        <div class="comparison-card">
                            <div class="comparison-title">❌ Current Configuration</div>
                            <div class="metric-row">
                                <span class="metric-label">Monthly Cost:</span>
                                <span class="metric-value" id="current-cost">£0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Runtime:</span>
                                <span class="metric-value" id="current-runtime">0s</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Error Rate:</span>
                                <span class="metric-value" id="current-errors">0%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Throttling Risk:</span>
                                <span class="metric-value" id="current-throttling">Low</span>
                            </div>
                        </div>
                        <div class="comparison-card">
                            <div class="comparison-title">✅ Optimized Configuration</div>
                            <div class="metric-row">
                                <span class="metric-label">Monthly Cost:</span>
                                <span class="metric-value" id="optimized-cost">£0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Runtime:</span>
                                <span class="metric-value" id="optimized-runtime">0s</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Error Rate:</span>
                                <span class="metric-value" id="optimized-errors">0%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Throttling Risk:</span>
                                <span class="metric-value" id="optimized-throttling">None</span>
                            </div>
                        </div>
                    </div>
                    <div class="savings-highlight">
                        <div class="savings-amount" id="savings-amount">£0/month</div>
                        <div>Potential Monthly Savings with Optimization</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" onclick="exportConfig()">
                        📥 Export Configuration
                    </button>
                    <button type="button" class="btn btn-success" onclick="applyOptimizations()">
                        ✨ Apply All Optimizations
                    </button>
                    <button type="button" class="btn btn-warning" onclick="shareConfig()">
                        🔗 Share Configuration
                    </button>
                </div>
            </div>

            <div class="live-feedback-panel">
                <div class="feedback-header">
                    <h3><span class="live-indicator"></span>Live Issue Detection</h3>
                    <span id="issue-counter">0 Issues</span>
                </div>
                <div id="issues-container">
                    <!-- Issues will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Real-time issue detection system
        const issueDetector = {
            issues: [],
            
            connectorLimits: {
                'SharePoint': { rpm: 600, premium: false },
                'Teams': { rpm: 120, premium: false },
                'GraphAPI': { rpm: 150, premium: false },
                'SQL': { rpm: 300, premium: true },
                'CustomHTTP': { rpm: 60, premium: true },
                'Dataverse': { rpm: 6000, premium: false }
            },

            patternOverhead: {
                'simple': 1.0,
                'apply_to_each': 1.1,
                'nested_apply': 1.4,
                'parallel_branches': 0.9,
                'child_flows': 1.1
            },

            detect: function() {
                this.issues = [];
                const config = this.getConfiguration();
                
                // Check for throttling issues
                this.checkThrottling(config);
                
                // Check for timeout issues
                this.checkTimeout(config);
                
                // Check for licensing issues
                this.checkLicensing(config);
                
                // Check for performance issues
                this.checkPerformance(config);
                
                // Check for governance issues
                this.checkGovernance(config);
                
                // Check for cost optimization
                this.checkCostOptimization(config);
                
                // Check for error handling
                this.checkErrorHandling(config);
                
                // Check for concurrency issues
                this.checkConcurrency(config);
                
                // Update UI with detected issues
                this.updateUI();
                
                // Update efficiency score
                this.updateEfficiencyScore(config);
                
                // Update optimization preview
                this.updateOptimizationPreview(config);
            },

            getConfiguration: function() {
                return {
                    items: parseInt(document.getElementById('items').value) || 0,
                    actionsPerItem: parseInt(document.getElementById('actionsPerItem').value) || 0,
                    connector: document.getElementById('connector').value,
                    concurrency: parseInt(document.getElementById('concurrency').value) || 1,
                    executions: parseInt(document.getElementById('executions').value) || 1,
                    flowPattern: document.getElementById('flowPattern').value,
                    errorRate: parseInt(document.getElementById('errorRate').value) || 0,
                    avgMs: parseInt(document.getElementById('avgMs').value) || 500,
                    users: parseInt(document.getElementById('users').value) || 1,
                    premiumLicenses: parseInt(document.getElementById('premiumLicenses').value) || 0,
                    processLicenses: parseInt(document.getElementById('processLicenses').value) || 0,
                    governanceLevel: document.getElementById('governanceLevel').value
                };
            },

            checkThrottling: function(config) {
                const totalActions = config.items * config.actionsPerItem;
                const runtime = (config.items / config.concurrency) * config.avgMs;
                const rpm = (totalActions / (runtime / 60000)) * this.patternOverhead[config.flowPattern];
                const limit = this.connectorLimits[config.connector].rpm;
                
                if (rpm > limit * 0.8) {
                    const severity = rpm > limit ? 'critical' : 'warning';
                    this.issues.push({
                        type: severity,
                        title: '⚠️ Throttling Risk Detected',
                        description: `Your flow will hit ${Math.round(rpm)} requests/minute but ${config.connector} limits to ${limit} RPM.`,
                        impact: {
                            'Performance': '-60%',
                            'Reliability': '-40%',
                            'Runtime': '+200%'
                        },
                        solution: {
                            text: `Reduce concurrency to ${Math.max(1, Math.floor(config.concurrency * (limit / rpm) * 0.8))} or add ${Math.ceil(rpm / 50)} second delays between actions.`,
                            autoFix: () => {
                                document.getElementById('concurrency').value = Math.max(1, Math.floor(config.concurrency * (limit / rpm) * 0.8));
                                this.detect();
                            }
                        }
                    });
                }
            },

            checkTimeout: function(config) {
                const runtime = (config.items / config.concurrency) * config.avgMs * this.patternOverhead[config.flowPattern];
                const runtimeMinutes = runtime / 60000;
                
                if (runtimeMinutes > 30) {
                    this.issues.push({
                        type: 'critical',
                        title: '⏱️ Timeout Risk',
                        description: `Flow will run for ${Math.round(runtimeMinutes)} minutes, exceeding 30-minute timeout.`,
                        impact: {
                            'Completion': '0%',
                            'Data Loss': 'High',
                            'Cost': '+100%'
                        },
                        solution: {
                            text: `Split into batches of ${Math.floor(config.items * 30 / runtimeMinutes)} items or increase concurrency to ${Math.ceil(config.concurrency * runtimeMinutes / 30)}.`,
                            autoFix: () => {
                                document.getElementById('items').value = Math.floor(config.items * 30 / runtimeMinutes);
                                this.detect();
                            }
                        }
                    });
                }
            },

            checkLicensing: function(config) {
                const totalPPR = config.items * config.actionsPerItem * config.executions * 30;
                const isPremium = this.connectorLimits[config.connector].premium;
                
                if (isPremium && config.premiumLicenses === 0 && config.processLicenses === 0) {
                    this.issues.push({
                        type: 'critical',
                        title: '💰 Premium License Required',
                        description: `${config.connector} requires premium licensing (enforced April 1, 2025).`,
                        impact: {
                            'Cost': '+£12.20/user',
                            'Compliance': 'Required',
                            'Deadline': 'Apr 2025'
                        },
                        solution: {
                            text: `Add ${config.users} Premium licenses (£${(config.users * 12.20).toFixed(2)}/month) or 1 Process license (£81.90/month).`,
                            autoFix: () => {
                                document.getElementById('processLicenses').value = 1;
                                this.detect();
                            }
                        }
                    });
                }
                
                if (totalPPR > 1200000 && config.processLicenses === 0) {
                    this.issues.push({
                        type: 'warning',
                        title: '📊 High PPR Usage',
                        description: `Using ${(totalPPR/1000000).toFixed(1)}M PPR/month exceeds user license limits.`,
                        impact: {
                            'Throttling': 'High',
                            'Cost': 'Inefficient',
                            'Scalability': 'Limited'
                        },
                        solution: {
                            text: `Add ${Math.ceil(totalPPR / 7500000)} Process license(s) for better PPR allocation.`,
                            autoFix: () => {
                                document.getElementById('processLicenses').value = Math.ceil(totalPPR / 7500000);
                                this.detect();
                            }
                        }
                    });
                }
            },

            checkPerformance: function(config) {
                if (config.flowPattern === 'nested_apply' && config.items > 1000) {
                    this.issues.push({
                        type: 'warning',
                        title: '🔄 Nested Loop Performance',
                        description: 'Nested Apply to Each with large datasets causes exponential slowdown.',
                        impact: {
                            'Performance': '-40%',
                            'Memory': 'High',
                            'Timeout Risk': '+60%'
                        },
                        solution: {
                            text: 'Use Select action to filter data first, or restructure to avoid nested loops.',
                            autoFix: () => {
                                document.getElementById('flowPattern').value = 'parallel_branches';
                                this.detect();
                            }
                        }
                    });
                }
                
                if (config.concurrency > 20 && config.connector !== 'Dataverse') {
                    this.issues.push({
                        type: 'info',
                        title: '⚡ High Concurrency',
                        description: `Concurrency of ${config.concurrency} may cause resource contention.`,
                        impact: {
                            'Stability': '-20%',
                            'Errors': '+15%'
                        },
                        solution: {
                            text: 'Optimal concurrency is typically 4-8 for most connectors.',
                            autoFix: () => {
                                document.getElementById('concurrency').value = 8;
                                this.detect();
                            }
                        }
                    });
                }
            },

            checkGovernance: function(config) {
                if (config.governanceLevel === 'none') {
                    this.issues.push({
                        type: 'warning',
                        title: '🛡️ Governance Risk',
                        description: 'No governance can lead to compliance issues (see Kaplan case: £5.4M fine).',
                        impact: {
                            'GDPR Risk': 'High',
                            'Audit': 'Failed',
                            'Fine Risk': '£1000s'
                        },
                        solution: {
                            text: 'Implement at least basic governance: naming conventions, approval process, documentation.',
                            autoFix: () => {
                                document.getElementById('governanceLevel').value = 'basic';
                                this.detect();
                            }
                        }
                    });
                }
            },

            checkCostOptimization: function(config) {
                const monthlyPPR = config.items * config.actionsPerItem * config.executions * 30;
                const processLicensePPR = 250000 * 30; // 7.5M per month
                
                if (config.premiumLicenses > 3 && monthlyPPR > processLicensePPR) {
                    const premiumCost = config.premiumLicenses * 12.20;
                    const processCost = 81.90;
                    
                    if (premiumCost > processCost) {
                        this.issues.push({
                            type: 'info',
                            title: '💡 Cost Optimization Available',
                            description: `Save £${(premiumCost - processCost).toFixed(2)}/month by switching to Process license.`,
                            impact: {
                                'Savings': `£${((premiumCost - processCost) * 12).toFixed(0)}/year`,
                                'PPR': '+7.5M/month',
                                'Scalability': 'Better'
                            },
                            solution: {
                                text: 'Replace Premium licenses with 1 Process license for this flow.',
                                autoFix: () => {
                                    document.getElementById('processLicenses').value = 1;
                                    document.getElementById('premiumLicenses').value = 0;
                                    this.detect();
                                }
                            }
                        });
                    }
                }
            },

            checkErrorHandling: function(config) {
                if (config.errorRate > 20) {
                    this.issues.push({
                        type: 'warning',
                        title: '❌ High Error Rate',
                        description: `${config.errorRate}% error rate will cause excessive retries and PPR consumption.`,
                        impact: {
                            'PPR Usage': `+${config.errorRate * 2}%`,
                            'Runtime': `+${config.errorRate}%`,
                            'Reliability': 'Poor'
                        },
                        solution: {
                            text: 'Add try-catch scopes, implement exponential backoff, validate data before processing.',
                            autoFix: () => {
                                document.getElementById('errorRate').value = 5;
                                this.detect();
                            }
                        }
                    });
                }
            },

            checkConcurrency: function(config) {
                if (config.concurrency === 1 && config.items > 1000) {
                    const optimalConcurrency = Math.min(20, Math.ceil(config.items / 100));
                    const timeSaved = Math.round(((config.items * config.avgMs) - (config.items * config.avgMs / optimalConcurrency)) / 60000);
                    
                    this.issues.push({
                        type: 'info',
                        title: '🚀 Performance Boost Available',
                        description: `Enable concurrency to save ${timeSaved} minutes per run.`,
                        impact: {
                            'Runtime': `-${Math.round((1 - 1/optimalConcurrency) * 100)}%`,
                            'Efficiency': '+High',
                            'Time Saved': `${timeSaved}min`
                        },
                        solution: {
                            text: `Set concurrency to ${optimalConcurrency} for optimal performance.`,
                            autoFix: () => {
                                document.getElementById('concurrency').value = optimalConcurrency;
                                this.detect();
                            }
                        }
                    });
                }
            },

            updateUI: function() {
                const container = document.getElementById('issues-container');
                const banner = document.getElementById('issues-banner');
                const counter = document.getElementById('issue-counter');
                const issueCount = document.getElementById('issue-count');
                const issueSummary = document.getElementById('issue-summary');
                
                container.innerHTML = '';
                
                if (this.issues.length === 0) {
                    container.innerHTML = `
                        <div class="issue-card success">
                            <div class="issue-header">
                                <span class="issue-icon">✅</span>
                                <span class="issue-title">All Systems Optimal!</span>
                            </div>
                            <div class="issue-description">
                                Your flow configuration is optimized. No issues detected.
                            </div>
                        </div>
                    `;
                    banner.style.display = 'none';
                } else {
                    // Sort issues by severity
                    const sortOrder = { critical: 0, warning: 1, info: 2, success: 3 };
                    this.issues.sort((a, b) => sortOrder[a.type] - sortOrder[b.type]);
                    
                    // Update banner
                    const criticalCount = this.issues.filter(i => i.type === 'critical').length;
                    const warningCount = this.issues.filter(i => i.type === 'warning').length;
                    
                    banner.style.display = 'block';
                    banner.className = 'live-issues-banner';
                    
                    if (criticalCount > 0) {
                        banner.classList.add('critical');
                        issueSummary.textContent = `${criticalCount} critical issue${criticalCount > 1 ? 's' : ''} will prevent your flow from working!`;
                    } else if (warningCount > 0) {
                        banner.classList.add('warning');
                        issueSummary.textContent = `${warningCount} warning${warningCount > 1 ? 's' : ''} may impact performance`;
                    } else {
                        banner.classList.add('info');
                        issueSummary.textContent = `${this.issues.length} optimization${this.issues.length > 1 ? 's' : ''} available`;
                    }
                    
                    issueCount.textContent = this.issues.length;
                    counter.textContent = `${this.issues.length} Issue${this.issues.length > 1 ? 's' : ''}`;
                    
                    // Add issue cards
                    this.issues.forEach((issue, index) => {
                        const card = document.createElement('div');
                        card.className = `issue-card ${issue.type}`;
                        card.style.animationDelay = `${index * 0.1}s`;
                        
                        let impactHtml = '';
                        if (issue.impact) {
                            impactHtml = '<div class="issue-impact">';
                            for (const [key, value] of Object.entries(issue.impact)) {
                                const isPositive = value.toString().startsWith('+') && !value.includes('%');
                                impactHtml += `
                                    <div class="impact-item">
                                        <span class="impact-label">${key}:</span>
                                        <span class="impact-value ${isPositive ? 'positive' : ''}">${value}</span>
                                    </div>
                                `;
                            }
                            impactHtml += '</div>';
                        }
                        
                        let solutionHtml = '';
                        if (issue.solution) {
                            solutionHtml = `
                                <div class="issue-solution">
                                    <div class="solution-header">💡 Recommended Fix:</div>
                                    <div class="solution-text">${issue.solution.text}</div>
                                    ${issue.solution.autoFix ? `
                                        <button class="btn btn-success" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9rem;" 
                                                onclick="issueDetector.issues[${index}].solution.autoFix()">
                                            ✨ Auto-Fix This Issue
                                        </button>
                                    ` : ''}
                                </div>
                            `;
                        }
                        
                        card.innerHTML = `
                            <div class="issue-header">
                                <span class="issue-icon">${issue.title.split(' ')[0]}</span>
                                <span class="issue-title">${issue.title.substring(issue.title.indexOf(' ') + 1)}</span>
                            </div>
                            <div class="issue-description">${issue.description}</div>
                            ${impactHtml}
                            ${solutionHtml}
                        `;
                        
                        container.appendChild(card);
                    });
                }
                
                // Update optimization score
                document.getElementById('optimization-score').textContent = this.issues.length;
            },

            updateEfficiencyScore: function(config) {
                let score = 100;
                
                // Deduct points for issues
                this.issues.forEach(issue => {
                    if (issue.type === 'critical') score -= 20;
                    else if (issue.type === 'warning') score -= 10;
                    else if (issue.type === 'info') score -= 5;
                });
                
                score = Math.max(0, score);
                
                // Update circle
                const circle = document.getElementById('efficiency-circle');
                circle.style.strokeDasharray = `${score}, 100`;
                
                // Update color based on score
                if (score >= 80) {
                    circle.style.stroke = '#4CAF50';
                } else if (score >= 60) {
                    circle.style.stroke = '#FFA726';
                } else {
                    circle.style.stroke = '#EF5350';
                }
                
                // Update text
                document.getElementById('efficiency-score').textContent = `${score}%`;
                
                // Update other metrics
                const monthlyPPR = config.items * config.actionsPerItem * config.executions * 30;
                const runtime = (config.items / config.concurrency) * config.avgMs;
                
                // Calculate cost
                let monthlyCost = 0;
                if (config.processLicenses > 0) {
                    monthlyCost += config.processLicenses * 81.90;
                } else if (config.premiumLicenses > 0) {
                    monthlyCost += config.premiumLicenses * 12.20;
                } else if (this.connectorLimits[config.connector].premium) {
                    monthlyCost += config.users * 12.20;
                }
                
                document.getElementById('cost-score').textContent = `£${monthlyCost.toFixed(2)}`;
                document.getElementById('performance-score').textContent = `${Math.round(runtime / 1000)}s`;
                document.getElementById('reliability-score').textContent = `${100 - config.errorRate}%`;
            },

            updateOptimizationPreview: function(config) {
                // Current metrics
                const currentRuntime = (config.items / config.concurrency) * config.avgMs * this.patternOverhead[config.flowPattern];
                let currentCost = 0;
                
                if (config.processLicenses > 0) {
                    currentCost = config.processLicenses * 81.90;
                } else if (config.premiumLicenses > 0) {
                    currentCost = config.premiumLicenses * 12.20;
                } else if (this.connectorLimits[config.connector].premium) {
                    currentCost = config.users * 12.20;
                }
                
                // Optimized metrics (if all fixes applied)
                let optimizedConfig = { ...config };
                
                // Apply optimizations
                if (config.flowPattern === 'nested_apply') {
                    optimizedConfig.flowPattern = 'parallel_branches';
                }
                if (config.concurrency === 1 && config.items > 1000) {
                    optimizedConfig.concurrency = Math.min(20, Math.ceil(config.items / 100));
                }
                if (config.errorRate > 20) {
                    optimizedConfig.errorRate = 5;
                }
                
                const optimizedRuntime = (optimizedConfig.items / optimizedConfig.concurrency) * optimizedConfig.avgMs * this.patternOverhead[optimizedConfig.flowPattern];
                
                // Optimize licensing
                let optimizedCost = currentCost;
                const monthlyPPR = config.items * config.actionsPerItem * config.executions * 30;
                if (config.premiumLicenses > 3 && monthlyPPR > 7500000) {
                    optimizedCost = 81.90; // Switch to Process license
                }
                
                // Update UI
                document.getElementById('current-cost').textContent = `£${currentCost.toFixed(2)}`;
                document.getElementById('current-runtime').textContent = `${Math.round(currentRuntime / 1000)}s`;
                document.getElementById('current-errors').textContent = `${config.errorRate}%`;
                
                const rpm = (config.items * config.actionsPerItem / (currentRuntime / 60000)) * this.patternOverhead[config.flowPattern];
                const limit = this.connectorLimits[config.connector].rpm;
                document.getElementById('current-throttling').textContent = rpm > limit * 0.8 ? 'High' : 'Low';
                
                document.getElementById('optimized-cost').textContent = `£${optimizedCost.toFixed(2)}`;
                document.getElementById('optimized-runtime').textContent = `${Math.round(optimizedRuntime / 1000)}s`;
                document.getElementById('optimized-errors').textContent = `${optimizedConfig.errorRate}%`;
                document.getElementById('optimized-throttling').textContent = 'None';
                
                const savings = currentCost - optimizedCost;
                document.getElementById('savings-amount').textContent = savings > 0 ? `£${savings.toFixed(2)}/month` : 'Already Optimized';
            }
        };

        // Apply all optimizations
        function applyOptimizations() {
            const fixes = issueDetector.issues.filter(i => i.solution && i.solution.autoFix);
            if (fixes.length === 0) {
                alert('No automatic optimizations available. Your flow is already optimized!');
                return;
            }
            
            if (confirm(`Apply ${fixes.length} optimization${fixes.length > 1 ? 's' : ''}?`)) {
                fixes.forEach(issue => {
                    if (issue.solution && issue.solution.autoFix) {
                        issue.solution.autoFix();
                    }
                });
            }
        }

        // Export configuration
        function exportConfig() {
            const config = issueDetector.getConfiguration();
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flow-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Share configuration
        function shareConfig() {
            const config = issueDetector.getConfiguration();
            const encoded = btoa(JSON.stringify(config));
            const url = `${window.location.origin}${window.location.pathname}?config=${encoded}`;
            
            navigator.clipboard.writeText(url).then(() => {
                alert('Configuration URL copied to clipboard!');
            });
        }

        // Load configuration from URL
        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('config')) {
                try {
                    const config = JSON.parse(atob(params.get('config')));
                    Object.keys(config).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = config[key];
                        }
                    });
                } catch (e) {
                    console.error('Failed to load configuration from URL:', e);
                }
            }
        }

        // Real-time input validation
        function addInputValidation() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    const min = parseInt(this.min);
                    const max = parseInt(this.max);
                    const feedback = document.getElementById(`${this.id}-feedback`);
                    
                    if (value < min || value > max) {
                        this.classList.add('error');
                        if (feedback) {
                            feedback.textContent = `Value must be between ${min} and ${max}`;
                            feedback.classList.add('show');
                        }
                    } else {
                        this.classList.remove('error');
                        if (feedback) {
                            feedback.classList.remove('show');
                        }
                    }
                    
                    // Trigger real-time detection
                    issueDetector.detect();
                });
            });
            
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('change', () => issueDetector.detect());
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFromUrl();
            addInputValidation();
            issueDetector.detect();
        });
    </script>
</body>
</html>